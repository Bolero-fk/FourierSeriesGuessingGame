<!DOCTYPE HTML>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>フーリエ級数</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="./DrawFourier.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/js/modaal.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modaal@0.4.4/dist/css/modaal.min.css">
</head>

<body>
    <style>
        #ex_chart {
            max-width: 80%;
            max-height: 80%;
        }
    </style>

    <script>
        const MIN_COEFFICIENT = 0;
        const MAX_COEFFICIENT = 1;
        const COEFFICIENT_STEP = 0.05;
        const INITIAL_VALUE = (MAX_COEFFICIENT - MIN_COEFFICIENT) / 2;

        function SetRangeSettings(elementId) {
            var rangeElement = document.getElementById(elementId);
            rangeElement.setAttribute("min", MIN_COEFFICIENT);
            rangeElement.setAttribute("max", MAX_COEFFICIENT);
            rangeElement.setAttribute("step", COEFFICIENT_STEP);
            rangeElement.setAttribute("value", INITIAL_VALUE);
        }
    </script>


    <div class="modalWindow"></div>
    <div id="modal" style="display:none;">
        <h2>
            <center>
                Clear!<br>
                <input type="button" value="Restart Game" onClick="RestartGame()">
            </center>
        </h2>
    </div>

    <script>
        // モーダルウィンドウの設定
        $(".modalWindow").modaal({
            content_source: '#modal',
        });
    </script>


    <canvas id="ex_chart"></canvas>
    <label>a1<input type="range" id="fourier-a1"></label>
    <label>a5<input type="range" id="fourier-a5"></label>
    <label>a10<input type="range" id="fourier-a10"></label>
    <label>a25<input type="range" id="fourier-a20"></label>
    <label>a50<input type="range" id="fourier-a50"></label>
    <input type="button" onclick="CheckGraph()" value="Check">

    <script>
        SetRangeSettings("fourier-a1");
        SetRangeSettings("fourier-a5");
        SetRangeSettings("fourier-a10");
        SetRangeSettings("fourier-a20");
        SetRangeSettings("fourier-a50");
    </script>

    <font size="7">Score: <span id="score">0.00%</span></font>

    <p id=math>
        <span id="checkCount">1</span>回目: <b><span id="a1">0.50</span></b>sin&theta; + <b><span
                id="a5">0.50</span></b>sin5&theta;
        +
        <b><span id="a10">0.50</span></b>sin10&theta; + <b><span id="a20">0.50</span></b>sin20&theta; + <b><span
                id="a50">0.50</span></b>sin50&theta;
    </p>

    <script>
        var chart = InitializeGame(MIN_COEFFICIENT, MAX_COEFFICIENT, COEFFICIENT_STEP, [1, 5, 10, 20, 50]);

        const range1Elem = document.getElementById('fourier-a1');
        const range2Elem = document.getElementById('fourier-a5');
        const range3Elem = document.getElementById('fourier-a10');
        const range4Elem = document.getElementById('fourier-a20');
        const range5Elem = document.getElementById('fourier-a50');

        const text1Elem = document.getElementById('a1');
        const text2Elem = document.getElementById('a5');
        const text3Elem = document.getElementById('a10');
        const text4Elem = document.getElementById('a20');
        const text5Elem = document.getElementById('a50');

        const checkCountElem = document.getElementById("checkCount");

        const scoreElem = document.getElementById('score');

        window.onload = () => {
            range1Elem.addEventListener('input', graphChange);
            range2Elem.addEventListener('input', graphChange);
            range3Elem.addEventListener('input', graphChange);
            range4Elem.addEventListener('input', graphChange);
            range5Elem.addEventListener('input', graphChange);
        }

        function graphChange() {
            ChangeGraph(chart, GetAnswerCoefficients());
            text1Elem.innerText = Number.parseFloat(range1Elem.value).toFixed(2);
            text2Elem.innerText = Number.parseFloat(range2Elem.value).toFixed(2);
            text3Elem.innerText = Number.parseFloat(range3Elem.value).toFixed(2);
            text4Elem.innerText = Number.parseFloat(range4Elem.value).toFixed(2);
            text5Elem.innerText = Number.parseFloat(range5Elem.value).toFixed(2);
        }

        function CheckGraph() {
            if (parseInt(checkCountElem.innerText) < 6) {
                UpdateHintGraph(chart, GetAnswerCoefficients());
                UpdatePastAnswers();
                UpdateScore(chart);
                checkCountElem.innerText = parseInt(checkCountElem.innerText) + 1;
                if (parseInt(checkCountElem.innerText) == 6) {
                    ShowCorrectAnswer();
                }
            }

            if (parseInt(checkCountElem.innerText) > 5) {
                ClearGame();
            }
        }

        function GetAnswerCoefficients() {
            return [parseFloat(range1Elem.value), parseFloat(range2Elem.value), parseFloat(range3Elem.value), parseFloat(range4Elem.value), parseFloat(range5Elem.value)];
        }

        function UpdateScore() {
            scoreElem.innerHTML = GetScore().toString() + "%";
        }

        function UpdatePastAnswers() {
            var newAnchor = document.createElement("a");
            newAnchor.innerHTML = GetPastAnswerHTML();

            // li 要素の作成
            var newLi = document.createElement("li");
            newLi.appendChild(newAnchor);

            // リストに追加
            var list = document.getElementById("PastAnswers");
            list.appendChild(newLi);

            // スクロール要素の高さ
            var scrollHeight = document.getElementById("scrollBox").scrollHeight;
            document.getElementById("scrollBox").scrollTop = scrollHeight;

            ScrollToBottom();
        }

        function GetPastAnswerHTML() {
            var answerStatuses = GetAnswerStatuses(GetAnswerCoefficients());
            var copyElement = document.getElementById("math").cloneNode(true);
            for (var i = 1; i < copyElement.childElementCount; i++) {
                if (answerStatuses[i - 1] == 1)
                    copyElement.children[i].style.color = "#faae2b";
                else if (answerStatuses[i - 1] == 2)
                    copyElement.children[i].style.color = "#2cb67d";
            }
            return copyElement.innerHTML;
        }

        function RestartGame() {
            chart = InitializeGame(MIN_COEFFICIENT, MAX_COEFFICIENT, COEFFICIENT_STEP, [1, 5, 10, 20, 50]);
            $(".modalWindow").modaal('close');
            range1Elem.value = INITIAL_VALUE;
            range2Elem.value = INITIAL_VALUE;
            range3Elem.value = INITIAL_VALUE;
            range4Elem.value = INITIAL_VALUE;
            range5Elem.value = INITIAL_VALUE;
            text1Elem.innerText = Number.parseFloat(range1Elem.value).toFixed(2);
            text2Elem.innerText = Number.parseFloat(range2Elem.value).toFixed(2);
            text3Elem.innerText = Number.parseFloat(range3Elem.value).toFixed(2);
            text4Elem.innerText = Number.parseFloat(range4Elem.value).toFixed(2);
            text5Elem.innerText = Number.parseFloat(range5Elem.value).toFixed(2);
            scoreElem.innerHTML = "0.00" + "%";
            document.getElementById("PastAnswers").innerHTML = "";
            checkCountElem.innerText = 1;
        }

        function ShowCorrectAnswer() {
            range1Elem.disabled = true;
            range2Elem.disabled = true;
            range3Elem.disabled = true;
            range4Elem.disabled = true;
            range5Elem.disabled = true;
            range1Elem.value = GetCorrectAnswers()[0];
            range2Elem.value = GetCorrectAnswers()[1];
            range3Elem.value = GetCorrectAnswers()[2];
            range4Elem.value = GetCorrectAnswers()[3];
            range5Elem.value = GetCorrectAnswers()[4];
            ChangeGraph(chart, GetAnswerCoefficients());
            text1Elem.innerText = Number.parseFloat(range1Elem.value).toFixed(2);
            text2Elem.innerText = Number.parseFloat(range2Elem.value).toFixed(2);
            text3Elem.innerText = Number.parseFloat(range3Elem.value).toFixed(2);
            text4Elem.innerText = Number.parseFloat(range4Elem.value).toFixed(2);
            text5Elem.innerText = Number.parseFloat(range5Elem.value).toFixed(2);
        }

        function ScrollToBottom() {
            // スクロール要素の高さ
            var scrollHeight = document.getElementById("scrollBox").scrollHeight;
            document.getElementById("scrollBox").scrollTop = scrollHeight;
        }

        function ClearGame() {
            $(".modalWindow").modaal('open');
        }

    </script>
    <div id="scrollBox" class="scroll">
        <ul id="PastAnswers">
        </ul>
    </div>
    </p>

</body>

</html>